# ğŸ¯ è½»é‡çº§é‡è°ƒåº¦å™¨ - å®è·µç»ƒä¹ æŒ‡å—

## ğŸ“š ç»ƒä¹ 1ï¼šé…ç½®è°ƒä¼˜å®éªŒ

### å®éªŒç›®æ ‡
ç†è§£é…ç½®å‚æ•°å¯¹é‡è°ƒåº¦è¡Œä¸ºçš„å½±å“

### å®éªŒæ­¥éª¤

#### æ­¥éª¤1ï¼šåŸºçº¿æµ‹è¯•
```bash
# 1. éƒ¨ç½²é»˜è®¤é…ç½®çš„é‡è°ƒåº¦å™¨
kubectl apply -f deploy/

# 2. åˆ›å»ºæµ‹è¯•å·¥ä½œè´Ÿè½½
kubectl create deployment test-app --image=nginx --replicas=10

# 3. è§‚å¯Ÿ5åˆ†é’Ÿçš„é‡è°ƒåº¦è¡Œä¸º
kubectl logs -f -l app=lightweight-descheduler -n kube-system
```

#### æ­¥éª¤2ï¼šè°ƒæ•´é©±é€é™åˆ¶
```bash
# ä¿®æ”¹ ConfigMap ä¸­çš„é©±é€é™åˆ¶
kubectl patch configmap lightweight-descheduler-config -n kube-system --type merge -p '{
  "data": {
    "config.yaml": "interval: \"2m\"\nlimits:\n  maxPodsToEvictPerNode: 2\n  maxPodsToEvictTotal: 5\n..."
  }
}'

# é‡å¯é‡è°ƒåº¦å™¨åº”ç”¨é…ç½®
kubectl rollout restart deployment/lightweight-descheduler -n kube-system

# è§‚å¯Ÿå˜åŒ–
```

#### æ­¥éª¤3ï¼šæµ‹è¯•DryRunæ¨¡å¼
```bash
# å¯ç”¨DryRunæ¨¡å¼
kubectl patch configmap lightweight-descheduler-config -n kube-system --type merge -p '{
  "data": {
    "config.yaml": "dryRun: true\n..."
  }
}'

# è§‚å¯Ÿæ—¥å¿—ä¸­çš„ [DryRun] æ ‡è®°
kubectl logs -f -l app=lightweight-descheduler -n kube-system | grep DryRun
```

## ğŸ“š ç»ƒä¹ 2ï¼šç­–ç•¥è¡Œä¸ºåˆ†æ

### å®éªŒç›®æ ‡
æ·±å…¥ç†è§£æ¯ä¸ªç­–ç•¥çš„è§¦å‘æ¡ä»¶å’Œæ‰§è¡Œé€»è¾‘

### å®éªŒåœºæ™¯Aï¼šå¤±è´¥Podæ¸…ç†
```bash
# 1. åˆ›å»ºä¼šå¤±è´¥çš„Pod
kubectl run failing-pod-1 --image=busybox --restart=Never -- /bin/sh -c "exit 1"
kubectl run failing-pod-2 --image=invalid-image --restart=Never

# 2. ç­‰å¾…Podå¤±è´¥
kubectl get pods --field-selector=status.phase=Failed

# 3. è§‚å¯Ÿé‡è°ƒåº¦å™¨æ¸…ç†è¿™äº›å¤±è´¥çš„Pod
kubectl logs -l app=lightweight-descheduler -n kube-system | grep "RemoveFailedPods"

# 4. éªŒè¯æ¸…ç†ç»“æœ
kubectl get pods --field-selector=status.phase=Failed
```

### å®éªŒåœºæ™¯Bï¼šèŠ‚ç‚¹èµ„æºä¸å‡è¡¡
```bash
# 1. åˆ›å»ºèµ„æºå¯†é›†å‹å·¥ä½œè´Ÿè½½ï¼Œåªåœ¨ç‰¹å®šèŠ‚ç‚¹
kubectl create deployment cpu-heavy --image=progrium/stress -- --cpu 2
kubectl patch deployment cpu-heavy -p '{
  "spec": {
    "template": {
      "spec": {
        "nodeSelector": {"kubernetes.io/hostname": "worker-node-1"}
      }
    }
  }
}'

# 2. æ‰©å±•å‰¯æœ¬æ•°é€ æˆä¸å‡è¡¡
kubectl scale deployment cpu-heavy --replicas=5

# 3. è§‚å¯Ÿé‡è°ƒåº¦å™¨çš„å¹³è¡¡æ“ä½œ
kubectl logs -l app=lightweight-descheduler -n kube-system | grep "LowNodeUtilization"
```

## ğŸ“š ç»ƒä¹ 3ï¼šè‡ªå®šä¹‰ç­–ç•¥å¼€å‘

### å®éªŒç›®æ ‡
å­¦ä¹ å¦‚ä½•æ‰©å±•é‡è°ƒåº¦å™¨ï¼Œæ·»åŠ æ–°çš„ç­–ç•¥

### æ­¥éª¤1ï¼šè®¾è®¡æ–°ç­–ç•¥
```go
// æ–°ç­–ç•¥ï¼šæ ¹æ®Podå¹´é¾„æ¸…ç†è€æ—§Pod
type RemoveOldPodsStrategy struct {
    client  kubernetes.Interface
    config  *config.RemoveOldPodsConfig
    context *StrategyContext
}

// é…ç½®ç»“æ„
type RemoveOldPodsConfig struct {
    Enabled        bool          `yaml:"enabled"`
    MaxPodAge      time.Duration `yaml:"maxPodAge"`
    ExcludedOwners []string      `yaml:"excludedOwners"`
}
```

### æ­¥éª¤2ï¼šå®ç°ç­–ç•¥é€»è¾‘
```go
func (s *RemoveOldPodsStrategy) Execute(ctx context.Context, nodes []*v1.Node) error {
    for _, node := range nodes {
        pods, err := s.getPodsOnNode(ctx, node.Name)
        if err != nil {
            continue
        }
        
        for _, pod := range pods {
            if s.isPodTooOld(pod) && s.canEvictPod(pod) {
                s.context.Evictor.EvictPod(ctx, pod, "Pod too old")
            }
        }
    }
    return nil
}
```

### æ­¥éª¤3ï¼šé›†æˆåˆ°å·¥å‚
```go
// åœ¨ StrategyFactory.CreateStrategies() ä¸­æ·»åŠ 
if f.context.Config.Strategies.RemoveOldPods != nil &&
   f.context.Config.Strategies.RemoveOldPods.Enabled {
    strategies = append(strategies, NewRemoveOldPodsStrategy(f.context))
}
```

## ğŸ“š ç»ƒä¹ 4ï¼šç›‘æ§å’Œè°ƒè¯•

### å®éªŒç›®æ ‡
æŒæ¡é‡è°ƒåº¦å™¨çš„ç›‘æ§å’Œè°ƒè¯•æŠ€èƒ½

### ç›‘æ§ä»»åŠ¡
```bash
# 1. å®æ—¶ç›‘æ§é‡è°ƒåº¦å™¨æ—¥å¿—
kubectl logs -f -l app=lightweight-descheduler -n kube-system

# 2. ç›‘æ§é›†ç¾¤Podå˜åŒ–
kubectl get pods --all-namespaces --watch

# 3. ç›‘æ§èŠ‚ç‚¹èµ„æºä½¿ç”¨
kubectl top nodes

# 4. ç›‘æ§Podèµ„æºä½¿ç”¨
kubectl top pods --all-namespaces
```

### è°ƒè¯•ä»»åŠ¡
```bash
# 1. å¢åŠ æ—¥å¿—çº§åˆ«
kubectl patch deployment lightweight-descheduler -n kube-system -p '{
  "spec": {
    "template": {
      "spec": {
        "containers": [{
          "name": "lightweight-descheduler",
          "args": ["-config=/etc/descheduler/config.yaml", "-log-level=4"]
        }]
      }
    }
  }
}'

# 2. ä½¿ç”¨kubectl execè¿›å…¥å®¹å™¨è°ƒè¯•
kubectl exec -it -n kube-system deployment/lightweight-descheduler -- /bin/sh

# 3. æ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®åŠ è½½
kubectl exec -n kube-system deployment/lightweight-descheduler -- cat /etc/descheduler/config.yaml
```

## ğŸ“š ç»ƒä¹ 5ï¼šæ€§èƒ½æµ‹è¯•

### å®éªŒç›®æ ‡
è¯„ä¼°é‡è°ƒåº¦å™¨åœ¨ä¸åŒè§„æ¨¡ä¸‹çš„æ€§èƒ½

### æµ‹è¯•åœºæ™¯
```bash
# 1. å°è§„æ¨¡æµ‹è¯• (10ä¸ªèŠ‚ç‚¹ï¼Œ100ä¸ªPod)
# 2. ä¸­ç­‰è§„æ¨¡æµ‹è¯• (50ä¸ªèŠ‚ç‚¹ï¼Œ500ä¸ªPod)  
# 3. å¤§è§„æ¨¡æµ‹è¯• (100ä¸ªèŠ‚ç‚¹ï¼Œ1000ä¸ªPod)

# æ€§èƒ½æŒ‡æ ‡æ”¶é›†
# - é‡è°ƒåº¦å‘¨æœŸæ‰§è¡Œæ—¶é—´
# - å†…å­˜ä½¿ç”¨é‡
# - CPUä½¿ç”¨é‡
# - æ¯åˆ†é’Ÿå¤„ç†çš„Podæ•°é‡
```

## ğŸ¯ å­¦ä¹ æ£€æŸ¥æ¸…å•

### ç†è®ºç†è§£ âœ…
- [ ] ç†è§£Kubernetesé‡è°ƒåº¦çš„æ¦‚å¿µå’Œä½œç”¨
- [ ] æŒæ¡Podé©±é€APIçš„å·¥ä½œåŸç†
- [ ] ç†è§£ç­–ç•¥æ¨¡å¼åœ¨é‡è°ƒåº¦å™¨ä¸­çš„åº”ç”¨
- [ ] æŒæ¡Goè¯­è¨€åœ¨Kuberneteså¼€å‘ä¸­çš„æœ€ä½³å®è·µ

### ä»£ç èƒ½åŠ› âœ…
- [ ] èƒ½å¤Ÿé˜…è¯»å’Œç†è§£ç°æœ‰ç­–ç•¥çš„å®ç°
- [ ] èƒ½å¤Ÿä¿®æ”¹é…ç½®å‚æ•°å¹¶é¢„æµ‹å½±å“
- [ ] èƒ½å¤Ÿæ·»åŠ æ–°çš„é‡è°ƒåº¦ç­–ç•¥
- [ ] èƒ½å¤Ÿè°ƒè¯•å’Œæ’æŸ¥é‡è°ƒåº¦å™¨é—®é¢˜

### è¿ç»´æŠ€èƒ½ âœ…
- [ ] èƒ½å¤Ÿéƒ¨ç½²å’Œé…ç½®é‡è°ƒåº¦å™¨
- [ ] èƒ½å¤Ÿç›‘æ§é‡è°ƒåº¦å™¨çš„è¿è¡ŒçŠ¶æ€
- [ ] èƒ½å¤Ÿè°ƒä¼˜é‡è°ƒåº¦å™¨çš„æ€§èƒ½
- [ ] èƒ½å¤Ÿå¤„ç†é‡è°ƒåº¦å™¨çš„æ•…éšœ

## ğŸš€ è¿›é˜¶å­¦ä¹ å»ºè®®

### æ‰©å±•æ–¹å‘
1. **é›†æˆPrometheusç›‘æ§** - æ·»åŠ metricså¯¼å‡º
2. **WebHookæ”¯æŒ** - æ·»åŠ å¤–éƒ¨é€šçŸ¥èƒ½åŠ›
3. **å¤šé›†ç¾¤æ”¯æŒ** - æ‰©å±•åˆ°å¤šKubernetesé›†ç¾¤
4. **AIå¢å¼º** - ä½¿ç”¨æœºå™¨å­¦ä¹ ä¼˜åŒ–é‡è°ƒåº¦å†³ç­–

### ç›¸å…³é¡¹ç›®å­¦ä¹ 
1. **å®˜æ–¹Descheduler** - å­¦ä¹ å®˜æ–¹å®ç°çš„é«˜çº§ç‰¹æ€§
2. **Cluster Autoscaler** - å­¦ä¹ èŠ‚ç‚¹è‡ªåŠ¨ä¼¸ç¼©
3. **Vertical Pod Autoscaler** - å­¦ä¹ Podèµ„æºè‡ªåŠ¨è°ƒæ•´
4. **Scheduler Framework** - å­¦ä¹ è°ƒåº¦å™¨æ‰©å±•æœºåˆ¶
