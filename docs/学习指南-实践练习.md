# 🎯 轻量级重调度器 - 实践练习指南

## 📚 练习1：配置调优实验

### 实验目标
理解配置参数对重调度行为的影响

### 实验步骤

#### 步骤1：基线测试
```bash
# 1. 部署默认配置的重调度器
kubectl apply -f deploy/

# 2. 创建测试工作负载
kubectl create deployment test-app --image=nginx --replicas=10

# 3. 观察5分钟的重调度行为
kubectl logs -f -l app=lightweight-descheduler -n kube-system
```

#### 步骤2：调整驱逐限制
```bash
# 修改 ConfigMap 中的驱逐限制
kubectl patch configmap lightweight-descheduler-config -n kube-system --type merge -p '{
  "data": {
    "config.yaml": "interval: \"2m\"\nlimits:\n  maxPodsToEvictPerNode: 2\n  maxPodsToEvictTotal: 5\n..."
  }
}'

# 重启重调度器应用配置
kubectl rollout restart deployment/lightweight-descheduler -n kube-system

# 观察变化
```

#### 步骤3：测试DryRun模式
```bash
# 启用DryRun模式
kubectl patch configmap lightweight-descheduler-config -n kube-system --type merge -p '{
  "data": {
    "config.yaml": "dryRun: true\n..."
  }
}'

# 观察日志中的 [DryRun] 标记
kubectl logs -f -l app=lightweight-descheduler -n kube-system | grep DryRun
```

## 📚 练习2：策略行为分析

### 实验目标
深入理解每个策略的触发条件和执行逻辑

### 实验场景A：失败Pod清理
```bash
# 1. 创建会失败的Pod
kubectl run failing-pod-1 --image=busybox --restart=Never -- /bin/sh -c "exit 1"
kubectl run failing-pod-2 --image=invalid-image --restart=Never

# 2. 等待Pod失败
kubectl get pods --field-selector=status.phase=Failed

# 3. 观察重调度器清理这些失败的Pod
kubectl logs -l app=lightweight-descheduler -n kube-system | grep "RemoveFailedPods"

# 4. 验证清理结果
kubectl get pods --field-selector=status.phase=Failed
```

### 实验场景B：节点资源不均衡
```bash
# 1. 创建资源密集型工作负载，只在特定节点
kubectl create deployment cpu-heavy --image=progrium/stress -- --cpu 2
kubectl patch deployment cpu-heavy -p '{
  "spec": {
    "template": {
      "spec": {
        "nodeSelector": {"kubernetes.io/hostname": "worker-node-1"}
      }
    }
  }
}'

# 2. 扩展副本数造成不均衡
kubectl scale deployment cpu-heavy --replicas=5

# 3. 观察重调度器的平衡操作
kubectl logs -l app=lightweight-descheduler -n kube-system | grep "LowNodeUtilization"
```

## 📚 练习3：自定义策略开发

### 实验目标
学习如何扩展重调度器，添加新的策略

### 步骤1：设计新策略
```go
// 新策略：根据Pod年龄清理老旧Pod
type RemoveOldPodsStrategy struct {
    client  kubernetes.Interface
    config  *config.RemoveOldPodsConfig
    context *StrategyContext
}

// 配置结构
type RemoveOldPodsConfig struct {
    Enabled        bool          `yaml:"enabled"`
    MaxPodAge      time.Duration `yaml:"maxPodAge"`
    ExcludedOwners []string      `yaml:"excludedOwners"`
}
```

### 步骤2：实现策略逻辑
```go
func (s *RemoveOldPodsStrategy) Execute(ctx context.Context, nodes []*v1.Node) error {
    for _, node := range nodes {
        pods, err := s.getPodsOnNode(ctx, node.Name)
        if err != nil {
            continue
        }
        
        for _, pod := range pods {
            if s.isPodTooOld(pod) && s.canEvictPod(pod) {
                s.context.Evictor.EvictPod(ctx, pod, "Pod too old")
            }
        }
    }
    return nil
}
```

### 步骤3：集成到工厂
```go
// 在 StrategyFactory.CreateStrategies() 中添加
if f.context.Config.Strategies.RemoveOldPods != nil &&
   f.context.Config.Strategies.RemoveOldPods.Enabled {
    strategies = append(strategies, NewRemoveOldPodsStrategy(f.context))
}
```

## 📚 练习4：监控和调试

### 实验目标
掌握重调度器的监控和调试技能

### 监控任务
```bash
# 1. 实时监控重调度器日志
kubectl logs -f -l app=lightweight-descheduler -n kube-system

# 2. 监控集群Pod变化
kubectl get pods --all-namespaces --watch

# 3. 监控节点资源使用
kubectl top nodes

# 4. 监控Pod资源使用
kubectl top pods --all-namespaces
```

### 调试任务
```bash
# 1. 增加日志级别
kubectl patch deployment lightweight-descheduler -n kube-system -p '{
  "spec": {
    "template": {
      "spec": {
        "containers": [{
          "name": "lightweight-descheduler",
          "args": ["-config=/etc/descheduler/config.yaml", "-log-level=4"]
        }]
      }
    }
  }
}'

# 2. 使用kubectl exec进入容器调试
kubectl exec -it -n kube-system deployment/lightweight-descheduler -- /bin/sh

# 3. 检查配置是否正确加载
kubectl exec -n kube-system deployment/lightweight-descheduler -- cat /etc/descheduler/config.yaml
```

## 📚 练习5：性能测试

### 实验目标
评估重调度器在不同规模下的性能

### 测试场景
```bash
# 1. 小规模测试 (10个节点，100个Pod)
# 2. 中等规模测试 (50个节点，500个Pod)  
# 3. 大规模测试 (100个节点，1000个Pod)

# 性能指标收集
# - 重调度周期执行时间
# - 内存使用量
# - CPU使用量
# - 每分钟处理的Pod数量
```

## 🎯 学习检查清单

### 理论理解 ✅
- [ ] 理解Kubernetes重调度的概念和作用
- [ ] 掌握Pod驱逐API的工作原理
- [ ] 理解策略模式在重调度器中的应用
- [ ] 掌握Go语言在Kubernetes开发中的最佳实践

### 代码能力 ✅
- [ ] 能够阅读和理解现有策略的实现
- [ ] 能够修改配置参数并预测影响
- [ ] 能够添加新的重调度策略
- [ ] 能够调试和排查重调度器问题

### 运维技能 ✅
- [ ] 能够部署和配置重调度器
- [ ] 能够监控重调度器的运行状态
- [ ] 能够调优重调度器的性能
- [ ] 能够处理重调度器的故障

## 🚀 进阶学习建议

### 扩展方向
1. **集成Prometheus监控** - 添加metrics导出
2. **WebHook支持** - 添加外部通知能力
3. **多集群支持** - 扩展到多Kubernetes集群
4. **AI增强** - 使用机器学习优化重调度决策

### 相关项目学习
1. **官方Descheduler** - 学习官方实现的高级特性
2. **Cluster Autoscaler** - 学习节点自动伸缩
3. **Vertical Pod Autoscaler** - 学习Pod资源自动调整
4. **Scheduler Framework** - 学习调度器扩展机制
