# ğŸš€ è½»é‡çº§ Kubernetes é‡è°ƒåº¦å™¨ - å¿«é€Ÿä½¿ç”¨æŒ‡å—

æ­å–œï¼æ‚¨ç°åœ¨æ‹¥æœ‰äº†ä¸€ä¸ªå®Œæ•´çš„è½»é‡çº§ Kubernetes é‡è°ƒåº¦å™¨ã€‚è¿™æ˜¯ä¸€ä¸ªä¸“ä¸ºåˆå­¦è€…è®¾è®¡çš„é¡¹ç›®ï¼Œè®©æ‚¨èƒ½å¤Ÿè½»æ¾ç†è§£å’Œä½¿ç”¨ Kubernetes é‡è°ƒåº¦æŠ€æœ¯ã€‚

## ğŸ¯ é¡¹ç›®å®Œæˆæƒ…å†µ

âœ… **æ‰€æœ‰åŠŸèƒ½å·²å®Œæˆ**ï¼š
- âœ… æ ¸å¿ƒé‡è°ƒåº¦å¼•æ“
- âœ… ä¸‰ç§é‡è°ƒåº¦ç­–ç•¥ï¼ˆå¤±è´¥Podæ¸…ç†ã€èŠ‚ç‚¹èµ„æºå¹³è¡¡ã€é‡å¤Podæ¸…ç†ï¼‰
- âœ… å®Œæ•´çš„é…ç½®ç³»ç»Ÿ
- âœ… Podé©±é€å™¨å’Œå®‰å…¨æœºåˆ¶
- âœ… è¯¦ç»†çš„ä¸­æ–‡æ–‡æ¡£
- âœ… å®Œæ•´çš„éƒ¨ç½²é…ç½®
- âœ… æµ‹è¯•è„šæœ¬å’Œç¤ºä¾‹

## ğŸ“ é¡¹ç›®ç»“æ„æ€»è§ˆ

```
lightweight-descheduler/
â”œâ”€â”€ cmd/main.go                    # ç¨‹åºå…¥å£
â”œâ”€â”€ pkg/                           # æ ¸å¿ƒä»£ç åŒ…
â”‚   â”œâ”€â”€ config/config.go          # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ scheduler/scheduler.go    # ä¸»è°ƒåº¦å™¨
â”‚   â”œâ”€â”€ eviction/evictor.go       # Podé©±é€å™¨
â”‚   â”œâ”€â”€ strategies/               # é‡è°ƒåº¦ç­–ç•¥
â”‚   â”‚   â”œâ”€â”€ strategy.go           # ç­–ç•¥æ¥å£
â”‚   â”‚   â”œâ”€â”€ remove_failed_pods.go # å¤±è´¥Podæ¸…ç†
â”‚   â”‚   â”œâ”€â”€ low_node_utilization.go # èŠ‚ç‚¹èµ„æºå¹³è¡¡
â”‚   â”‚   â””â”€â”€ remove_duplicates.go  # é‡å¤Podæ¸…ç†
â”‚   â””â”€â”€ utils/utils.go            # å·¥å…·å‡½æ•°
â”œâ”€â”€ configs/config.yaml           # é…ç½®æ–‡ä»¶ç¤ºä¾‹
â”œâ”€â”€ deploy/                       # Kuberneteséƒ¨ç½²æ–‡ä»¶
â”‚   â”œâ”€â”€ rbac.yaml                # RBACæƒé™é…ç½®
â”‚   â”œâ”€â”€ configmap.yaml           # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ deployment.yaml          # Deploymentéƒ¨ç½²
â”‚   â””â”€â”€ cronjob.yaml             # CronJobéƒ¨ç½²
â”œâ”€â”€ examples/                     # ç¤ºä¾‹å’Œæµ‹è¯•
â”‚   â”œâ”€â”€ test-scenarios.yaml     # æµ‹è¯•åœºæ™¯
â”‚   â””â”€â”€ test-descheduler.sh     # æµ‹è¯•è„šæœ¬
â”œâ”€â”€ docs/                        # è¯¦ç»†æ–‡æ¡£
â”œâ”€â”€ Dockerfile                   # Dockeré•œåƒæ„å»º
â”œâ”€â”€ Makefile                     # æ„å»ºè„šæœ¬
â””â”€â”€ go.mod                       # Goæ¨¡å—å®šä¹‰
```

## ğŸƒâ€â™‚ï¸ 5åˆ†é’Ÿå¿«é€Ÿå¼€å§‹

### 1. æ„å»ºé¡¹ç›®

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd lightweight-descheduler

# æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
make build

# æˆ–æ„å»ºDockeré•œåƒ
make docker-build
```

### 2. éƒ¨ç½²åˆ°é›†ç¾¤

```bash
# ä¸€é”®éƒ¨ç½²
make deploy

# æˆ–æ‰‹åŠ¨éƒ¨ç½²
kubectl apply -f deploy/rbac.yaml
kubectl apply -f deploy/configmap.yaml
kubectl apply -f deploy/deployment.yaml
```

### 3. éªŒè¯è¿è¡Œ

```bash
# æ£€æŸ¥çŠ¶æ€
make status

# æŸ¥çœ‹æ—¥å¿—
make logs
```

### 4. æµ‹è¯•åŠŸèƒ½

```bash
# è¿è¡Œå®Œæ•´æµ‹è¯•ï¼ˆæ¨èï¼‰
./examples/test-descheduler.sh test

# æˆ–è€…æ‰‹åŠ¨æµ‹è¯•
./examples/test-descheduler.sh dryrun  # å¯ç”¨å®‰å…¨æ¨¡å¼
./examples/test-descheduler.sh create  # åˆ›å»ºæµ‹è¯•åœºæ™¯
./examples/test-descheduler.sh monitor # ç›‘æ§æ—¥å¿—
```

## âš™ï¸ æ ¸å¿ƒåŠŸèƒ½

### 1. å¤±è´¥Podæ¸…ç†ç­–ç•¥
- è‡ªåŠ¨è¯†åˆ«å¹¶æ¸…ç†é•¿æ—¶é—´å¤±è´¥çš„Pod
- æ”¯æŒé…ç½®æœ€å°å­˜æ´»æ—¶é—´
- å¯æ’é™¤ç‰¹å®šçš„Ownerç±»å‹ï¼ˆå¦‚Jobï¼‰
- æ”¯æŒå‘½åç©ºé—´è¿‡æ»¤

### 2. èŠ‚ç‚¹èµ„æºå¹³è¡¡ç­–ç•¥  
- åŸºäºCPUã€å†…å­˜ã€Podæ•°é‡ç›‘æ§èŠ‚ç‚¹åˆ©ç”¨ç‡
- è‡ªåŠ¨å°†Podä»é«˜è´Ÿè½½èŠ‚ç‚¹è¿ç§»åˆ°ä½è´Ÿè½½èŠ‚ç‚¹
- å¯é…ç½®çš„åˆ©ç”¨ç‡é˜ˆå€¼
- æ™ºèƒ½çš„Podé€‰æ‹©ç®—æ³•

### 3. é‡å¤Podæ¸…ç†ç­–ç•¥
- è¯†åˆ«åŒä¸€èŠ‚ç‚¹ä¸Šçš„é‡å¤Podå®ä¾‹
- ä¿ç•™æœ€æ—§çš„Podï¼Œæ¸…ç†è¾ƒæ–°çš„é‡å¤å®ä¾‹
- æ”¯æŒOwnerç±»å‹å’Œå‘½åç©ºé—´è¿‡æ»¤
- å®‰å…¨çš„é‡å¤æ£€æµ‹æœºåˆ¶

### 4. å®‰å…¨é©±é€æœºåˆ¶
- å¤šé‡å®‰å…¨æ£€æŸ¥ï¼Œä¿æŠ¤å…³é”®Pod
- å¯é…ç½®çš„é©±é€é™åˆ¶ï¼ˆæŒ‰èŠ‚ç‚¹ã€å‘½åç©ºé—´ã€æ€»æ•°ï¼‰
- æ”¯æŒDryRunæ¨¡å¼è¿›è¡Œå®‰å…¨æµ‹è¯•
- ä½¿ç”¨Kubernetesæ ‡å‡†é©±é€API

## ğŸ”§ é…ç½®é€‰é¡¹

ä¸»è¦é…ç½®é€‰é¡¹ï¼š

```yaml
# åŸºæœ¬é…ç½®
interval: "5m"          # è¿è¡Œé—´éš”
dryRun: false           # æ˜¯å¦æ¨¡æ‹Ÿè¿è¡Œ
logLevel: "info"        # æ—¥å¿—çº§åˆ«

# é©±é€é™åˆ¶
limits:
  maxPodsToEvictPerNode: 5      # æ¯èŠ‚ç‚¹æœ€å¤§é©±é€æ•°
  maxPodsToEvictPerNamespace: 3 # æ¯å‘½åç©ºé—´æœ€å¤§é©±é€æ•°
  maxPodsToEvictTotal: 20       # æ€»æœ€å¤§é©±é€æ•°

# ç­–ç•¥é…ç½®
strategies:
  removeFailedPods:
    enabled: true
    minPodLifetimeSeconds: 300  # 5åˆ†é’Ÿ
  lowNodeUtilization:
    enabled: true
    thresholds:
      cpu: 20     # CPUåˆ©ç”¨ç‡é˜ˆå€¼
      memory: 20  # å†…å­˜åˆ©ç”¨ç‡é˜ˆå€¼
      pods: 20    # Podæ•°é‡é˜ˆå€¼
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
```bash
kubectl get pods -n kube-system -l app=lightweight-descheduler
```

### æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
```bash
kubectl logs -n kube-system -l app=lightweight-descheduler -f
```

### å…¸å‹æ—¥å¿—è¾“å‡º
```
=== Starting descheduling cycle ===
Found 3 available nodes
--- Executing strategy: RemoveFailedPods ---
Successfully evicted failed pod default/my-app-xxx on node worker-1
RemoveFailedPods strategy completed. Evicted: 1, Skipped: 0
--- Executing strategy: LowNodeUtilization ---
Node worker-1 utilization: CPU=85%, Memory=70%, Pods=60%
Node worker-2 utilization: CPU=15%, Memory=20%, Pods=30%
Successfully evicted pod default/resource-app-yyy from over-utilized node worker-1
=== Cycle Statistics ===
Duration: 3.2s
Total evicted: 2
Evictions by node:
  worker-1: 2
```

## ğŸ›¡ï¸ å®‰å…¨æœ€ä½³å®è·µ

1. **é¦–æ¬¡ä½¿ç”¨DryRunæ¨¡å¼**
   ```bash
   # ä¿®æ”¹é…ç½®å¯ç”¨DryRun
   kubectl patch configmap lightweight-descheduler-config -n kube-system \
     --type merge -p '{"data":{"config.yaml":"dryRun: true\n..."}}'
   ```

2. **ä»ä¿å®ˆè®¾ç½®å¼€å§‹**
   - ä½¿ç”¨è¾ƒå°çš„é©±é€é™åˆ¶
   - è¾ƒé•¿çš„è¿è¡Œé—´éš”
   - æ’é™¤é‡è¦çš„å‘½åç©ºé—´

3. **ç›‘æ§åº”ç”¨å½±å“**
   - è§‚å¯ŸæœåŠ¡å¯ç”¨æ€§
   - ç›‘æ§åº”ç”¨é‡å¯æ¬¡æ•°
   - æ£€æŸ¥èµ„æºåˆ©ç”¨ç‡å˜åŒ–

## ğŸš€ ç”Ÿäº§ç¯å¢ƒä½¿ç”¨

### æ¨èé…ç½®
```yaml
interval: "10m"         # è¾ƒé•¿é—´éš”ï¼Œå‡å°‘é¢‘ç¹æ“ä½œ
dryRun: false
logLevel: "info"

# ä¿å®ˆçš„é©±é€é™åˆ¶
limits:
  maxPodsToEvictPerNode: 3
  maxPodsToEvictPerNamespace: 2
  maxPodsToEvictTotal: 15

# æ’é™¤é‡è¦å‘½åç©ºé—´
strategies:
  removeFailedPods:
    excludedNamespaces:
      - "kube-system"
      - "monitoring"
      - "ingress"
```

### éƒ¨ç½²å»ºè®®
- ä½¿ç”¨CronJobæ¨¡å¼ä»¥é™ä½èµ„æºå ç”¨
- é…ç½®é€‚å½“çš„èµ„æºé™åˆ¶
- è®¾ç½®ç›‘æ§å’Œå‘Šè­¦
- å®šæœŸæ£€æŸ¥å’Œè°ƒæ•´é…ç½®

## ğŸ“š å­¦ä¹ èµ„æº

### ä»£ç å­¦ä¹ 
1. **ä» `cmd/main.go` å¼€å§‹** - äº†è§£ç¨‹åºå…¥å£å’Œåˆå§‹åŒ–
2. **é˜…è¯» `pkg/scheduler/scheduler.go`** - ç†è§£ä¸»è°ƒåº¦å¾ªç¯
3. **ç ”ç©¶ç­–ç•¥å®ç°** - å­¦ä¹ å…·ä½“çš„é‡è°ƒåº¦ç®—æ³•
4. **æŸ¥çœ‹é©±é€å™¨** - äº†è§£å®‰å…¨é©±é€æœºåˆ¶

### æ–‡æ¡£é˜…è¯»
- [è¯¦ç»†æ–‡æ¡£](./docs/README.md) - å®Œæ•´çš„ä½¿ç”¨æŒ‡å—
- [é…ç½®æŒ‡å—](./docs/configuration.md) - æ‰€æœ‰é…ç½®é€‰é¡¹è¯´æ˜  
- [å¿«é€Ÿå¼€å§‹](./docs/quick-start.md) - å¿«é€Ÿéƒ¨ç½²æŒ‡å—

### æ‰©å±•å¼€å‘
- æ·»åŠ æ–°çš„é‡è°ƒåº¦ç­–ç•¥
- é›†æˆå¤–éƒ¨ç›‘æ§ç³»ç»Ÿ
- æ·»åŠ Webhooké€šçŸ¥
- é›†æˆPrometheusæŒ‡æ ‡

## ğŸ¤ è´¡çŒ®å’Œæ”¯æŒ

### æŠ¥å‘Šé—®é¢˜
å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š
1. æ£€æŸ¥æ—¥å¿—å’Œé…ç½®
2. æŸ¥çœ‹æ–‡æ¡£å’ŒFAQ
3. åœ¨GitHubæäº¤Issue

### è´¡çŒ®ä»£ç 
æ¬¢è¿æäº¤Pull Requestï¼š
1. Forké¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤ä»£ç å’Œæµ‹è¯•
4. å‘èµ·Pull Request

## ğŸ‰ æ€»ç»“

æ‚¨ç°åœ¨æ‹¥æœ‰äº†ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„è½»é‡çº§Kubernetesé‡è°ƒåº¦å™¨ï¼å®ƒå…·æœ‰ï¼š

- **ğŸ“ˆ ç”Ÿäº§å°±ç»ª** - å®Œæ•´çš„é”™è¯¯å¤„ç†ã€æ—¥å¿—ã€ç›‘æ§
- **ğŸ”’ å®‰å…¨å¯é ** - å¤šé‡ä¿æŠ¤æœºåˆ¶ã€DryRunæ¨¡å¼  
- **ğŸ¯ æ˜“äºä½¿ç”¨** - è¯¦ç»†æ–‡æ¡£ã€æµ‹è¯•è„šæœ¬ã€é…ç½®ç¤ºä¾‹
- **ğŸš€ æ˜“äºæ‰©å±•** - æ¸…æ™°çš„æ¶æ„ã€æ¨¡å—åŒ–è®¾è®¡
- **ğŸ“š å­¦ä¹ å‹å¥½** - è¯¦ç»†æ³¨é‡Šã€ä¸­æ–‡æ–‡æ¡£ã€å®Œæ•´ç¤ºä¾‹

è¿™ä¸ªé¡¹ç›®ä¸ä»…æ˜¯ä¸€ä¸ªå®ç”¨çš„å·¥å…·ï¼Œæ›´æ˜¯ä¸€ä¸ªä¼˜ç§€çš„å­¦ä¹ èµ„æºã€‚é€šè¿‡ç ”ç©¶å’Œä½¿ç”¨å®ƒï¼Œæ‚¨å°†æ·±å…¥ç†è§£ï¼š

- Kubernetes APIç¼–ç¨‹
- Goè¯­è¨€äº‘åŸç”Ÿå¼€å‘
- é›†ç¾¤è°ƒåº¦å’Œèµ„æºç®¡ç†
- ç³»ç»Ÿè®¾è®¡å’Œæ¶æ„æ¨¡å¼

**å¼€å§‹æ‚¨çš„Kubernetesé‡è°ƒåº¦ä¹‹æ—…å§ï¼** ğŸš€

---

**éœ€è¦å¸®åŠ©ï¼Ÿ** æŸ¥çœ‹ [docs/](./docs/) ç›®å½•è·å–è¯¦ç»†æ–‡æ¡£ï¼Œæˆ–ä½¿ç”¨æµ‹è¯•è„šæœ¬ `./examples/test-descheduler.sh test` å¿«é€Ÿä½“éªŒæ‰€æœ‰åŠŸèƒ½ï¼
