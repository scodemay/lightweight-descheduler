# 🚀 轻量级 Kubernetes 重调度器 - 快速使用指南

恭喜！您现在拥有了一个完整的轻量级 Kubernetes 重调度器。这是一个专为初学者设计的项目，让您能够轻松理解和使用 Kubernetes 重调度技术。

## 🎯 项目完成情况

✅ **所有功能已完成**：
- ✅ 核心重调度引擎
- ✅ 三种重调度策略（失败Pod清理、节点资源平衡、重复Pod清理）
- ✅ 完整的配置系统
- ✅ Pod驱逐器和安全机制
- ✅ 详细的中文文档
- ✅ 完整的部署配置
- ✅ 测试脚本和示例

## 📁 项目结构总览

```
lightweight-descheduler/
├── cmd/main.go                    # 程序入口
├── pkg/                           # 核心代码包
│   ├── config/config.go          # 配置管理
│   ├── scheduler/scheduler.go    # 主调度器
│   ├── eviction/evictor.go       # Pod驱逐器
│   ├── strategies/               # 重调度策略
│   │   ├── strategy.go           # 策略接口
│   │   ├── remove_failed_pods.go # 失败Pod清理
│   │   ├── low_node_utilization.go # 节点资源平衡
│   │   └── remove_duplicates.go  # 重复Pod清理
│   └── utils/utils.go            # 工具函数
├── configs/config.yaml           # 配置文件示例
├── deploy/                       # Kubernetes部署文件
│   ├── rbac.yaml                # RBAC权限配置
│   ├── configmap.yaml           # 配置文件
│   ├── deployment.yaml          # Deployment部署
│   └── cronjob.yaml             # CronJob部署
├── examples/                     # 示例和测试
│   ├── test-scenarios.yaml     # 测试场景
│   └── test-descheduler.sh     # 测试脚本
├── docs/                        # 详细文档
├── Dockerfile                   # Docker镜像构建
├── Makefile                     # 构建脚本
└── go.mod                       # Go模块定义
```

## 🏃‍♂️ 5分钟快速开始

### 1. 构建项目

```bash
# 进入项目目录
cd lightweight-descheduler

# 构建二进制文件
make build

# 或构建Docker镜像
make docker-build
```

### 2. 部署到集群

```bash
# 一键部署
make deploy

# 或手动部署
kubectl apply -f deploy/rbac.yaml
kubectl apply -f deploy/configmap.yaml
kubectl apply -f deploy/deployment.yaml
```

### 3. 验证运行

```bash
# 检查状态
make status

# 查看日志
make logs
```

### 4. 测试功能

```bash
# 运行完整测试（推荐）
./examples/test-descheduler.sh test

# 或者手动测试
./examples/test-descheduler.sh dryrun  # 启用安全模式
./examples/test-descheduler.sh create  # 创建测试场景
./examples/test-descheduler.sh monitor # 监控日志
```

## ⚙️ 核心功能

### 1. 失败Pod清理策略
- 自动识别并清理长时间失败的Pod
- 支持配置最小存活时间
- 可排除特定的Owner类型（如Job）
- 支持命名空间过滤

### 2. 节点资源平衡策略  
- 基于CPU、内存、Pod数量监控节点利用率
- 自动将Pod从高负载节点迁移到低负载节点
- 可配置的利用率阈值
- 智能的Pod选择算法

### 3. 重复Pod清理策略
- 识别同一节点上的重复Pod实例
- 保留最旧的Pod，清理较新的重复实例
- 支持Owner类型和命名空间过滤
- 安全的重复检测机制

### 4. 安全驱逐机制
- 多重安全检查，保护关键Pod
- 可配置的驱逐限制（按节点、命名空间、总数）
- 支持DryRun模式进行安全测试
- 使用Kubernetes标准驱逐API

## 🔧 配置选项

主要配置选项：

```yaml
# 基本配置
interval: "5m"          # 运行间隔
dryRun: false           # 是否模拟运行
logLevel: "info"        # 日志级别

# 驱逐限制
limits:
  maxPodsToEvictPerNode: 5      # 每节点最大驱逐数
  maxPodsToEvictPerNamespace: 3 # 每命名空间最大驱逐数
  maxPodsToEvictTotal: 20       # 总最大驱逐数

# 策略配置
strategies:
  removeFailedPods:
    enabled: true
    minPodLifetimeSeconds: 300  # 5分钟
  lowNodeUtilization:
    enabled: true
    thresholds:
      cpu: 20     # CPU利用率阈值
      memory: 20  # 内存利用率阈值
      pods: 20    # Pod数量阈值
```

## 📊 监控和日志

### 查看运行状态
```bash
kubectl get pods -n kube-system -l app=lightweight-descheduler
```

### 查看详细日志
```bash
kubectl logs -n kube-system -l app=lightweight-descheduler -f
```

### 典型日志输出
```
=== Starting descheduling cycle ===
Found 3 available nodes
--- Executing strategy: RemoveFailedPods ---
Successfully evicted failed pod default/my-app-xxx on node worker-1
RemoveFailedPods strategy completed. Evicted: 1, Skipped: 0
--- Executing strategy: LowNodeUtilization ---
Node worker-1 utilization: CPU=85%, Memory=70%, Pods=60%
Node worker-2 utilization: CPU=15%, Memory=20%, Pods=30%
Successfully evicted pod default/resource-app-yyy from over-utilized node worker-1
=== Cycle Statistics ===
Duration: 3.2s
Total evicted: 2
Evictions by node:
  worker-1: 2
```

## 🛡️ 安全最佳实践

1. **首次使用DryRun模式**
   ```bash
   # 修改配置启用DryRun
   kubectl patch configmap lightweight-descheduler-config -n kube-system \
     --type merge -p '{"data":{"config.yaml":"dryRun: true\n..."}}'
   ```

2. **从保守设置开始**
   - 使用较小的驱逐限制
   - 较长的运行间隔
   - 排除重要的命名空间

3. **监控应用影响**
   - 观察服务可用性
   - 监控应用重启次数
   - 检查资源利用率变化

## 🚀 生产环境使用

### 推荐配置
```yaml
interval: "10m"         # 较长间隔，减少频繁操作
dryRun: false
logLevel: "info"

# 保守的驱逐限制
limits:
  maxPodsToEvictPerNode: 3
  maxPodsToEvictPerNamespace: 2
  maxPodsToEvictTotal: 15

# 排除重要命名空间
strategies:
  removeFailedPods:
    excludedNamespaces:
      - "kube-system"
      - "monitoring"
      - "ingress"
```

### 部署建议
- 使用CronJob模式以降低资源占用
- 配置适当的资源限制
- 设置监控和告警
- 定期检查和调整配置

## 📚 学习资源

### 代码学习
1. **从 `cmd/main.go` 开始** - 了解程序入口和初始化
2. **阅读 `pkg/scheduler/scheduler.go`** - 理解主调度循环
3. **研究策略实现** - 学习具体的重调度算法
4. **查看驱逐器** - 了解安全驱逐机制

### 文档阅读
- [详细文档](./docs/README.md) - 完整的使用指南
- [配置指南](./docs/configuration.md) - 所有配置选项说明  
- [快速开始](./docs/quick-start.md) - 快速部署指南

### 扩展开发
- 添加新的重调度策略
- 集成外部监控系统
- 添加Webhook通知
- 集成Prometheus指标

## 🤝 贡献和支持

### 报告问题
如果遇到问题，请：
1. 检查日志和配置
2. 查看文档和FAQ
3. 在GitHub提交Issue

### 贡献代码
欢迎提交Pull Request：
1. Fork项目
2. 创建功能分支
3. 提交代码和测试
4. 发起Pull Request

## 🎉 总结

您现在拥有了一个功能完整的轻量级Kubernetes重调度器！它具有：

- **📈 生产就绪** - 完整的错误处理、日志、监控
- **🔒 安全可靠** - 多重保护机制、DryRun模式  
- **🎯 易于使用** - 详细文档、测试脚本、配置示例
- **🚀 易于扩展** - 清晰的架构、模块化设计
- **📚 学习友好** - 详细注释、中文文档、完整示例

这个项目不仅是一个实用的工具，更是一个优秀的学习资源。通过研究和使用它，您将深入理解：

- Kubernetes API编程
- Go语言云原生开发
- 集群调度和资源管理
- 系统设计和架构模式

**开始您的Kubernetes重调度之旅吧！** 🚀

---

**需要帮助？** 查看 [docs/](./docs/) 目录获取详细文档，或使用测试脚本 `./examples/test-descheduler.sh test` 快速体验所有功能！
