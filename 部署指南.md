# ğŸš€ è½»é‡çº§é‡è°ƒåº¦å™¨éƒ¨ç½²æŒ‡å—

## ğŸ“¦ é•œåƒæ„å»ºé€‰æ‹©

### é€‰æ‹©ä¸€ï¼šGitHub Actions è‡ªåŠ¨æ„å»ºï¼ˆæ¨èï¼‰

âœ… **ä¼˜ç‚¹**ï¼šæ— éœ€æœ¬åœ° Dockerï¼Œäº‘ç«¯è‡ªåŠ¨æ„å»º  
ğŸ¯ **é€‚åˆ**ï¼šåˆå­¦è€…ã€æ²¡æœ‰ Docker ç¯å¢ƒçš„ç”¨æˆ·

#### æ­¥éª¤ï¼š
1. **è®¾ç½® Docker Hub Secrets**
   ```bash
   # è®¿é—®ï¼šhttps://github.com/scodemay/lightweight-descheduler/settings/secrets/actions
   # ç‚¹å‡» "New repository secret" æ·»åŠ ï¼š
   DOCKER_USERNAME=æ‚¨çš„Docker Hubç”¨æˆ·å
   DOCKER_PASSWORD=æ‚¨çš„Docker Hubå¯†ç æˆ–è®¿é—®ä»¤ç‰Œ
   ```

2. **æ¨é€ä»£ç è§¦å‘æ„å»º**
   ```bash
   # ä»»ä½•æ¨é€åˆ° master åˆ†æ”¯éƒ½ä¼šè‡ªåŠ¨æ„å»º
   git push origin master
   
   # æ¨é€æ ‡ç­¾ä¼šæ„å»ºå¸¦ç‰ˆæœ¬çš„é•œåƒ
   git tag v1.0.1
   git push origin v1.0.1
   ```

3. **æŸ¥çœ‹æ„å»ºçŠ¶æ€**
   - è®¿é—®ï¼šhttps://github.com/scodemay/lightweight-descheduler/actions
   - æŸ¥çœ‹æ„å»ºæ—¥å¿—å’Œç»“æœ

### é€‰æ‹©äºŒï¼šæœ¬åœ° Docker æ„å»º

âœ… **ä¼˜ç‚¹**ï¼šå®Œå…¨æ§åˆ¶æ„å»ºè¿‡ç¨‹  
ğŸ¯ **é€‚åˆ**ï¼šæœ‰ Docker ç¯å¢ƒçš„å¼€å‘è€…

#### å‰ææ¡ä»¶ï¼š
```bash
# æ£€æŸ¥ Docker æ˜¯å¦è¿è¡Œ
docker --version
docker info

# å¦‚æœæ²¡è¿è¡Œï¼Œå¯åŠ¨ Docker
# macOS: æ‰“å¼€ Docker Desktop
# Linux: sudo systemctl start docker
```

#### ä½¿ç”¨æˆ‘ä»¬çš„æ„å»ºè„šæœ¬ï¼š
```bash
# æ£€æŸ¥ç¯å¢ƒ
./build.sh check

# æ„å»ºé•œåƒ
./build.sh build

# æ¨é€é•œåƒï¼ˆéœ€è¦å…ˆ docker loginï¼‰
./build.sh push

# ä¸€é”®å®Œæˆæ‰€æœ‰æ­¥éª¤
./build.sh all
```

#### æˆ–ä½¿ç”¨ Makefileï¼š
```bash
# æ„å»ºé•œåƒ
make docker-build

# ç™»å½• Docker Hub
docker login

# æ¨é€é•œåƒ
make docker-push
```

### é€‰æ‹©ä¸‰ï¼šæ‰‹åŠ¨ Docker å‘½ä»¤

```bash
# æ„å»ºé•œåƒ
docker build -t scodemay/lightweight-descheduler:v1.0.0 .

# ç™»å½• Docker Hub
docker login

# æ¨é€é•œåƒ
docker push scodemay/lightweight-descheduler:v1.0.0
```

## ğŸ¯ éƒ¨ç½²åˆ° Kubernetes

### å‰ææ¡ä»¶
```bash
# ç¡®ä¿æœ‰ kubectl å’Œé›†ç¾¤è®¿é—®æƒé™
kubectl cluster-info
kubectl get nodes
```

### å¿«é€Ÿéƒ¨ç½²
```bash
# ä¸€é”®éƒ¨ç½²
make deploy

# æˆ–æ‰‹åŠ¨éƒ¨ç½²
kubectl apply -f deploy/rbac.yaml
kubectl apply -f deploy/configmap.yaml
kubectl apply -f deploy/deployment.yaml
```

### æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
```bash
# æ£€æŸ¥ Pod çŠ¶æ€
kubectl get pods -n kube-system -l app=lightweight-descheduler

# æŸ¥çœ‹æ—¥å¿—
kubectl logs -n kube-system -l app=lightweight-descheduler -f

# æ£€æŸ¥é…ç½®
kubectl get configmap lightweight-descheduler-config -n kube-system -o yaml
```

## ğŸ”§ é…ç½®è°ƒæ•´

### ä¿®æ”¹é…ç½®
```bash
# ç¼–è¾‘é…ç½®
kubectl edit configmap lightweight-descheduler-config -n kube-system

# é‡å¯åº”ç”¨æ–°é…ç½®
kubectl rollout restart deployment/lightweight-descheduler -n kube-system
```

### å¯ç”¨ DryRun æ¨¡å¼ï¼ˆæ¨èé¦–æ¬¡ä½¿ç”¨ï¼‰
```bash
kubectl patch configmap lightweight-descheduler-config -n kube-system --type merge -p '{
  "data": {
    "config.yaml": "interval: \"5m\"\ndryRun: true\nlogLevel: \"debug\"\nlimits:\n  maxPodsToEvictPerNode: 5\n  maxPodsToEvictPerNamespace: 3\n  maxPodsToEvictTotal: 20\nstrategies:\n  removeFailedPods:\n    enabled: true\n    minPodLifetimeSeconds: 300\n    excludedNamespaces:\n      - \"kube-system\"\n  lowNodeUtilization:\n    enabled: true\n    numberOfNodes: 1\n    thresholds:\n      cpu: 20\n      memory: 20\n      pods: 20\n    targetThresholds:\n      cpu: 80\n      memory: 80\n      pods: 80"
  }
}'

# é‡å¯åº”ç”¨é…ç½®
kubectl rollout restart deployment/lightweight-descheduler -n kube-system
```

## ğŸ§ª æµ‹è¯•åŠŸèƒ½

### ä½¿ç”¨æµ‹è¯•è„šæœ¬
```bash
# è¿è¡Œå®Œæ•´æµ‹è¯•
./examples/test-descheduler.sh test

# åªç›‘æ§æ—¥å¿—
./examples/test-descheduler.sh monitor

# åˆ›å»ºæµ‹è¯•åœºæ™¯
./examples/test-descheduler.sh create
```

### æ‰‹åŠ¨åˆ›å»ºæµ‹è¯•åœºæ™¯
```bash
# åˆ›å»ºå¤±è´¥çš„ Pod
kubectl run failing-pod --image=busybox --restart=Never -- /bin/sh -c "exit 1"

# åˆ›å»ºèµ„æºå¯†é›†å‹åº”ç”¨
kubectl apply -f examples/test-scenarios.yaml
```

## ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
```bash
# å®æ—¶æ—¥å¿—
kubectl logs -n kube-system -l app=lightweight-descheduler -f

# æœ€è¿‘çš„æ—¥å¿—
kubectl logs -n kube-system -l app=lightweight-descheduler --tail=100

# æœç´¢ç‰¹å®šæ—¥å¿—
kubectl logs -n kube-system -l app=lightweight-descheduler | grep "Statistics"
```

### å¸¸è§é—®é¢˜æ’æŸ¥
```bash
# æ£€æŸ¥ RBAC æƒé™
kubectl auth can-i --list --as=system:serviceaccount:kube-system:lightweight-descheduler

# æ£€æŸ¥é•œåƒæ‹‰å–
kubectl describe pod -n kube-system -l app=lightweight-descheduler

# æ£€æŸ¥é…ç½®æ–‡ä»¶
kubectl get configmap lightweight-descheduler-config -n kube-system -o yaml
```

## ğŸ—‘ï¸ å¸è½½

```bash
# åˆ é™¤éƒ¨ç½²
kubectl delete -f deploy/

# æˆ–ä½¿ç”¨ Makefile
make undeploy
```

## ğŸ”„ æ›´æ–°é•œåƒ

### æ–¹æ³•ä¸€ï¼šæ¨é€æ–°æ ‡ç­¾ï¼ˆæ¨èï¼‰
```bash
# åˆ›å»ºæ–°ç‰ˆæœ¬
git tag v1.0.1
git push origin v1.0.1

# GitHub Actions ä¼šè‡ªåŠ¨æ„å»ºæ–°é•œåƒ
# ç„¶åæ›´æ–°éƒ¨ç½²æ–‡ä»¶ä¸­çš„é•œåƒæ ‡ç­¾
kubectl set image deployment/lightweight-descheduler \
  lightweight-descheduler=scodemay/lightweight-descheduler:v1.0.1 \
  -n kube-system
```

### æ–¹æ³•äºŒï¼šé‡æ–°æ„å»º
```bash
# æœ¬åœ°é‡æ–°æ„å»º
./build.sh all

# é‡å¯éƒ¨ç½²ä»¥æ‹‰å–æ–°é•œåƒ
kubectl rollout restart deployment/lightweight-descheduler -n kube-system
```

## ğŸ‰ æˆåŠŸéƒ¨ç½²éªŒè¯

å½“æ‚¨çœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„æ—¥å¿—æ—¶ï¼Œè¯´æ˜éƒ¨ç½²æˆåŠŸï¼š

```
I0101 12:00:00.000000       1 main.go:XX] Starting lightweight-descheduler v1.0.0
I0101 12:00:00.000000       1 scheduler.go:XX] Created scheduler with 2 enabled strategies
I0101 12:00:00.000000       1 scheduler.go:XX] === Starting descheduling cycle ===
I0101 12:00:00.000000       1 scheduler.go:XX] Found 3 available nodes
I0101 12:00:00.000000       1 strategies.go:XX] --- Executing strategy: RemoveFailedPods ---
I0101 12:00:00.000000       1 strategies.go:XX] RemoveFailedPods strategy completed. Evicted: 0, Skipped: 0
```

æ­å–œï¼æ‚¨çš„è½»é‡çº§é‡è°ƒåº¦å™¨å·²æˆåŠŸéƒ¨ç½²å¹¶è¿è¡Œï¼ğŸš€
