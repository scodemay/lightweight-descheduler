# 🚀 轻量级重调度器部署指南

## 📦 镜像构建选择

### 选择一：GitHub Actions 自动构建（推荐）

✅ **优点**：无需本地 Docker，云端自动构建  
🎯 **适合**：初学者、没有 Docker 环境的用户

#### 步骤：
1. **设置 Docker Hub Secrets**
   ```bash
   # 访问：https://github.com/scodemay/lightweight-descheduler/settings/secrets/actions
   # 点击 "New repository secret" 添加：
   DOCKER_USERNAME=您的Docker Hub用户名
   DOCKER_PASSWORD=您的Docker Hub密码或访问令牌
   ```

2. **推送代码触发构建**
   ```bash
   # 任何推送到 master 分支都会自动构建
   git push origin master
   
   # 推送标签会构建带版本的镜像
   git tag v1.0.1
   git push origin v1.0.1
   ```

3. **查看构建状态**
   - 访问：https://github.com/scodemay/lightweight-descheduler/actions
   - 查看构建日志和结果

### 选择二：本地 Docker 构建

✅ **优点**：完全控制构建过程  
🎯 **适合**：有 Docker 环境的开发者

#### 前提条件：
```bash
# 检查 Docker 是否运行
docker --version
docker info

# 如果没运行，启动 Docker
# macOS: 打开 Docker Desktop
# Linux: sudo systemctl start docker
```

#### 使用我们的构建脚本：
```bash
# 检查环境
./build.sh check

# 构建镜像
./build.sh build

# 推送镜像（需要先 docker login）
./build.sh push

# 一键完成所有步骤
./build.sh all
```

#### 或使用 Makefile：
```bash
# 构建镜像
make docker-build

# 登录 Docker Hub
docker login

# 推送镜像
make docker-push
```

### 选择三：手动 Docker 命令

```bash
# 构建镜像
docker build -t scodemay/lightweight-descheduler:v1.0.0 .

# 登录 Docker Hub
docker login

# 推送镜像
docker push scodemay/lightweight-descheduler:v1.0.0
```

## 🎯 部署到 Kubernetes

### 前提条件
```bash
# 确保有 kubectl 和集群访问权限
kubectl cluster-info
kubectl get nodes
```

### 快速部署
```bash
# 一键部署
make deploy

# 或手动部署
kubectl apply -f deploy/rbac.yaml
kubectl apply -f deploy/configmap.yaml
kubectl apply -f deploy/deployment.yaml
```

### 检查部署状态
```bash
# 检查 Pod 状态
kubectl get pods -n kube-system -l app=lightweight-descheduler

# 查看日志
kubectl logs -n kube-system -l app=lightweight-descheduler -f

# 检查配置
kubectl get configmap lightweight-descheduler-config -n kube-system -o yaml
```

## 🔧 配置调整

### 修改配置
```bash
# 编辑配置
kubectl edit configmap lightweight-descheduler-config -n kube-system

# 重启应用新配置
kubectl rollout restart deployment/lightweight-descheduler -n kube-system
```

### 启用 DryRun 模式（推荐首次使用）
```bash
kubectl patch configmap lightweight-descheduler-config -n kube-system --type merge -p '{
  "data": {
    "config.yaml": "interval: \"5m\"\ndryRun: true\nlogLevel: \"debug\"\nlimits:\n  maxPodsToEvictPerNode: 5\n  maxPodsToEvictPerNamespace: 3\n  maxPodsToEvictTotal: 20\nstrategies:\n  removeFailedPods:\n    enabled: true\n    minPodLifetimeSeconds: 300\n    excludedNamespaces:\n      - \"kube-system\"\n  lowNodeUtilization:\n    enabled: true\n    numberOfNodes: 1\n    thresholds:\n      cpu: 20\n      memory: 20\n      pods: 20\n    targetThresholds:\n      cpu: 80\n      memory: 80\n      pods: 80"
  }
}'

# 重启应用配置
kubectl rollout restart deployment/lightweight-descheduler -n kube-system
```

## 🧪 测试功能

### 使用测试脚本
```bash
# 运行完整测试
./examples/test-descheduler.sh test

# 只监控日志
./examples/test-descheduler.sh monitor

# 创建测试场景
./examples/test-descheduler.sh create
```

### 手动创建测试场景
```bash
# 创建失败的 Pod
kubectl run failing-pod --image=busybox --restart=Never -- /bin/sh -c "exit 1"

# 创建资源密集型应用
kubectl apply -f examples/test-scenarios.yaml
```

## 📊 监控和调试

### 查看详细日志
```bash
# 实时日志
kubectl logs -n kube-system -l app=lightweight-descheduler -f

# 最近的日志
kubectl logs -n kube-system -l app=lightweight-descheduler --tail=100

# 搜索特定日志
kubectl logs -n kube-system -l app=lightweight-descheduler | grep "Statistics"
```

### 常见问题排查
```bash
# 检查 RBAC 权限
kubectl auth can-i --list --as=system:serviceaccount:kube-system:lightweight-descheduler

# 检查镜像拉取
kubectl describe pod -n kube-system -l app=lightweight-descheduler

# 检查配置文件
kubectl get configmap lightweight-descheduler-config -n kube-system -o yaml
```

## 🗑️ 卸载

```bash
# 删除部署
kubectl delete -f deploy/

# 或使用 Makefile
make undeploy
```

## 🔄 更新镜像

### 方法一：推送新标签（推荐）
```bash
# 创建新版本
git tag v1.0.1
git push origin v1.0.1

# GitHub Actions 会自动构建新镜像
# 然后更新部署文件中的镜像标签
kubectl set image deployment/lightweight-descheduler \
  lightweight-descheduler=scodemay/lightweight-descheduler:v1.0.1 \
  -n kube-system
```

### 方法二：重新构建
```bash
# 本地重新构建
./build.sh all

# 重启部署以拉取新镜像
kubectl rollout restart deployment/lightweight-descheduler -n kube-system
```

## 🎉 成功部署验证

当您看到类似这样的日志时，说明部署成功：

```
I0101 12:00:00.000000       1 main.go:XX] Starting lightweight-descheduler v1.0.0
I0101 12:00:00.000000       1 scheduler.go:XX] Created scheduler with 2 enabled strategies
I0101 12:00:00.000000       1 scheduler.go:XX] === Starting descheduling cycle ===
I0101 12:00:00.000000       1 scheduler.go:XX] Found 3 available nodes
I0101 12:00:00.000000       1 strategies.go:XX] --- Executing strategy: RemoveFailedPods ---
I0101 12:00:00.000000       1 strategies.go:XX] RemoveFailedPods strategy completed. Evicted: 0, Skipped: 0
```

恭喜！您的轻量级重调度器已成功部署并运行！🚀
